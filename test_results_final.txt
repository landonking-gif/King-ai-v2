============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\dmilner.AGV-040318-PC\AppData\Local\Python\pythoncore-3.14-64\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2
configfile: pyproject.toml
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 12 items

tests/test_agents.py::test_research_agent_market_analysis PASSED         [  8%]
tests/test_agents.py::test_agent_router_delegation PASSED                [ 16%]
tests/test_agents.py::test_agent_router_invalid_agent PASSED             [ 25%]
tests/test_agents.py::test_list_agents PASSED                            [ 33%]
tests/test_business.py::test_business_creation PASSED                    [ 41%]
tests/test_business.py::test_lifecycle_transition FAILED                 [ 50%]
tests/test_business.py::test_portfolio_metrics FAILED                    [ 58%]
tests/test_master_ai.py::test_intent_classification_conversation PASSED  [ 66%]
tests/test_master_ai.py::test_intent_classification_command PASSED       [ 75%]
tests/test_master_ai.py::test_handle_query PASSED                        [ 83%]
tests/test_master_ai.py::test_evolution_rate_limiting PASSED             [ 91%]
tests/test_master_ai.py::test_autonomous_mode_toggle PASSED              [100%]

================================== FAILURES ===================================
__________________________ test_lifecycle_transition __________________________

    @pytest.mark.asyncio
    async def test_lifecycle_transition():
        """Test the state machine transitions in LifecycleEngine."""
        engine = LifecycleEngine()
    
        # Discovery -> Validation
        next_status = engine.get_next_status(BusinessStatus.DISCOVERY)
        assert next_status == BusinessStatus.VALIDATION
    
        # Operation -> Optimization
        next_status = engine.get_next_status(BusinessStatus.OPERATION)
        assert next_status == BusinessStatus.OPTIMIZATION
    
        # Sunset stays Sunset
        next_status = engine.get_next_status(BusinessStatus.SUNSET)
>       assert next_status == BusinessStatus.SUNSET
E       AssertionError: assert None == <BusinessStatus.SUNSET: 'sunset'>
E        +  where <BusinessStatus.SUNSET: 'sunset'> = BusinessStatus.SUNSET

tests\test_business.py:40: AssertionError
___________________________ test_portfolio_metrics ____________________________

    @pytest.mark.asyncio
    async def test_portfolio_metrics():
        """Test aggregate metric calculation in PortfolioManager."""
        from src.business.portfolio import PortfolioManager
    
        with patch('src.business.portfolio.get_db') as mock_db:
            # Mocking the database query result
            mock_session = MagicMock()
            mock_db.return_value.__aenter__.return_value = mock_session
    
            # Mocking result of context manager
            mock_result = MagicMock()
            mock_result.all.return_value = [
                BusinessUnit(total_revenue=1000, total_expenses=500),
                BusinessUnit(total_revenue=2000, total_expenses=1200)
            ]
            mock_session.execute = AsyncMock(return_value=mock_result)
    
            manager = PortfolioManager()
            metrics = await manager.get_total_stats()
    
>           assert metrics["total_revenue"] == 3000
E           assert 0 == 3000

tests\test_business.py:63: AssertionError
============================== warnings summary ===============================
config\settings.py:13
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:13: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    database_url: str = Field(..., env="DATABASE_URL")

config\settings.py:15
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:15: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    redis_url: str = Field(default="redis://localhost:6379", env="REDIS_URL")

config\settings.py:19
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:19: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    ollama_url: str = Field(..., env="OLLAMA_URL")

config\settings.py:21
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:21: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    ollama_model: str = Field(default="llama3.1:8b", env="OLLAMA_MODEL")

config\settings.py:25
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:25: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    pinecone_api_key: str | None = Field(default=None, env="PINECONE_API_KEY")

config\settings.py:27
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:27: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'env'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    pinecone_index: str = Field(default="king-ai", env="PINECONE_INDEX")

config\settings.py:5
  C:\Users\dmilner.AGV-040318-PC\Downloads\landon\king-ai-v2\config\settings.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_business.py::test_lifecycle_transition - AssertionError: as...
FAILED tests/test_business.py::test_portfolio_metrics - assert 0 == 3000
================== 2 failed, 10 passed, 7 warnings in 38.48s ==================
