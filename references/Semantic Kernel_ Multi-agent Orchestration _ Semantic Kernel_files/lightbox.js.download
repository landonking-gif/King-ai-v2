// Devblogs Lightbox — robust initializer + dynamic content support
(function () {
  if (window.DevblogsLightboxInitted) return;
  window.DevblogsLightboxInitted = true;

  // helpers
  const isImageHref = href => {
    if (!href) return false;
    return /\.(jpe?g|png|gif|webp|svg)(\?.*)?$/i.test(href);
  };

  const findLightboxAnchors = () => {
    const anchors = Array.from(document.querySelectorAll('a'));
    return anchors.filter(a => {
      const href = a.getAttribute('href') || '';
      const img = a.querySelector('img');
      // Only consider anchors that contain an image element
      if (!img) return false;
      // explicit markers
      if (a.classList.contains('lightbox-link') || a.dataset.featherlight !== undefined) return true;
      // image-like href
      if (isImageHref(href)) return true;
      // image marked for lightbox
      if (img.classList.contains('lightbox-enabled')) return true;
      // fallback: if href equals img src/data-src
      if (href && (href === img.src || href === img.getAttribute('data-src'))) return true;
      return false;
    });
  };

  // Create a single overlay + elements (reused)
  const overlay = document.createElement('div');
  overlay.className = 'devblogs-lightbox-overlay'; // keep CSS names consistent
  overlay.innerHTML = `
    <div class="devblogs-lightbox-content" role="dialog" aria-modal="true">
      <button class="devblogs-lightbox-close" aria-label="Close" type="button">&times;</button>
      <img class="devblogs-lightbox-img" alt="">
    </div>
  `;
  // Append safely — wait if body isn't ready yet
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      document.body.appendChild(overlay);
    });
  } else {
    document.body.appendChild(overlay);
  }
  const overlayContent = overlay.querySelector('.devblogs-lightbox-content');
  const closeBtn = overlay.querySelector('.devblogs-lightbox-close');
  const overlayImg = overlay.querySelector('.devblogs-lightbox-img');

  let lastFocusedEl = null;
  let trapHandler = null;

  // prevent layout shift when hiding scrollbar
  const setScrollbarVar = () => {
    const sw = window.innerWidth - document.documentElement.clientWidth;
    document.documentElement.style.setProperty('--scrollbar-width', `${sw}px`);
  };
  setScrollbarVar();
  window.addEventListener('resize', setScrollbarVar);

  function openLightbox(url, triggerEl, imgAlt) {
    lastFocusedEl = triggerEl || document.activeElement;
    overlayImg.src = url;
    overlayImg.alt = imgAlt || '';
    overlay.classList.add('active');
    document.body.classList.add('lightbox-open');

    let firstTabPress = true;

    // trap focus inside overlay
    trapHandler = function (e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeLightbox();
        return;
      }
      if (e.key === 'Tab') {
        const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        if (firstTabPress) {
          e.preventDefault();
          closeBtn.focus();
          firstTabPress = false;
          return;
        }

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    };
    document.addEventListener('keydown', trapHandler);
  }

  function closeLightbox() {
    overlay.classList.remove('active');
    document.body.classList.remove('lightbox-open');
    overlayImg.src = '';
    if (trapHandler) {
      document.removeEventListener('keydown', trapHandler);
      trapHandler = null;
    }
    // restore focus
    if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') {
      setTimeout(() => lastFocusedEl.focus(), 50);
    }
  }

  // Overlay interactions
  overlay.addEventListener('click', function (e) {
    if (e.target === overlay || e.target === closeBtn) closeLightbox();
  });

  closeBtn.addEventListener('click', closeLightbox);

  // Initialize anchor: remove tab from inner img, make anchor keyboard-activation friendly
  function initAnchor(a) {
    if (a.__devblogsInit) return;
    a.__devblogsInit = true;

    const href = a.getAttribute('href') || '';
    const img = a.querySelector('img');
    if (img) {
      // remove leftover plugin attributes so anchor is the single focus target
      img.removeAttribute('tabindex');
      img.removeAttribute('role');
      img.removeAttribute('aria-label');

      // Prefer data-src if present (lazy loading)
      const imgSrc = img.getAttribute('data-src') || img.getAttribute('src') || '';

      // Normalize (strip params, lowercase)
      const normalize = url => url ? url.split('?')[0].split('#')[0].toLowerCase() : '';
      const hrefNorm = normalize(href);
      const srcNorm = normalize(imgSrc);

      // add data-featherlight for styling/consistency if href matches image
      if (href && imgSrc && hrefNorm === srcNorm && !a.hasAttribute('data-featherlight')) {
        a.setAttribute('data-featherlight', 'image');
      }
    }

    // Ensure anchor is keyboard-focusable (anchors typically are)
    if (!a.hasAttribute('tabindex')) a.setAttribute('tabindex', '0');

    // Click handler
    a.addEventListener('click', function (evt) {
      // Only intercept unmodified primary (left) clicks
      if (evt.button === 0 && !evt.ctrlKey && !evt.metaKey && !evt.shiftKey && !evt.altKey) {
        evt.preventDefault();
        evt.stopPropagation();
        const href =
          a.getAttribute('href') ||
          (img && img.getAttribute('data-src')) ||
          (img && img.src) ||
          '';
        openLightbox(href, a, img ? img.alt : '');
      }
    });

    // Keyboard activation (Enter, Space)
    a.addEventListener('keydown', function (evt) {
      if (evt.key === 'Enter' || evt.key === ' ') {
        evt.preventDefault();
        evt.stopPropagation();
        const href = a.getAttribute('href') || (img && img.getAttribute('data-src')) || (img && img.src) || '';
        openLightbox(href, a, img ? img.alt : '');
      }
    });
  }

  // Discover and init existing anchors
  function discoverAndInit() {
    const anchors = findLightboxAnchors();
    if (!anchors.length) {
      // if still none found, we will keep the mutation observer running
      // console.debug('DevblogsLightbox: no anchors found yet');
    }
    anchors.forEach(initAnchor);
  }

  // Run initial discovery
  discoverAndInit();

  // MutationObserver to pick up anchors/images added dynamically
  const mo = new MutationObserver(mutations => {
    let found = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) {
        for (const n of m.addedNodes) {
          if (n.nodeType !== 1) continue;
          if (n.matches && n.matches('a')) { found = true; break; }
          if (n.querySelector && n.querySelector('img')) { found = true; break; }
        }
      }
    }
    if (found) discoverAndInit();
  });

  mo.observe(document.body, { childList: true, subtree: true });

  // Expose small API for debugging/reinit in console if needed
  window.DevblogsLightbox = {
    reinit: discoverAndInit,
    close: closeLightbox
  };

})();